let calendar,calendarioYaInicializado=!1,diaSeleccionadoEl=null;const inputFecha=document.querySelector('input[name="fecha"]'),inputHora=document.querySelector('input[name="hora"]'),contenedor=document.getElementById("horarios-container"),selectBarbero=document.querySelector('select[name="barberoID"]'),cita={fecha:"",hora:""};function ymdLocal(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function iniciarApp(){buscarPorFecha(),inicializarCalendario()}function buscarPorFecha(){inputFecha&&inputFecha.addEventListener("input",e=>{const a=e.target.value;window.location=`?fecha=${a}`})}async function inicializarCalendario(){const e=document.getElementById("calendario");if(!e||calendarioYaInicializado)return;const a=new Date;a.setHours(0,0,0,0),calendar=new FullCalendar.Calendar(e,{initialView:"dayGridMonth",locale:"es",firstDay:1,selectable:!0,editable:!1,timeZone:"local",headerToolbar:{left:"title",center:"",right:"prev,next"},dayCellDidMount:function(e){const o=new Date(e.date);o.setHours(0,0,0,0),0===o.getDay()||o<a?e.el.classList.add("dia-deshabilitado"):e.el.classList.add("habilitado")},dateClick:async function(e){if(e.dayEl.classList.contains("dia-deshabilitado"))return;diaSeleccionadoEl&&diaSeleccionadoEl.classList.remove("fecha-seleccionada"),diaSeleccionadoEl=e.dayEl,diaSeleccionadoEl.classList.add("fecha-seleccionada");const a=ymdLocal(e.date);inputFecha.value=a,cita.fecha=a,inputHora.value="",cita.hora="",selectBarbero.value&&"todos"!==selectBarbero.value?await generarBotonesBloqueosYReservas(a,selectBarbero.value):mostrarMensaje("Selecciona un barbero para ver los horarios")},datesSet:function(){if(!diaSeleccionadoEl&&0!==a.getDay()){const o=ymdLocal(a),r=e.querySelector(`[data-date="${o}"]`);r&&(r.classList.add("fecha-seleccionada"),diaSeleccionadoEl=r,inputFecha.value=o,cita.fecha=o,selectBarbero.value&&"todos"!==selectBarbero.value&&generarBotonesBloqueosYReservas(o,selectBarbero.value))}}}),calendar.render(),calendarioYaInicializado=!0}function mostrarMensaje(e){contenedor.innerHTML=`<p class="mensaje-no-horarios">${e}</p>`}function generarRangoHorarios(e,a,o,r,t,n,s){let c=60*e+a;const i=60*o+r;for(;c<=i;){const e=`${String(Math.floor(c/60)).padStart(2,"0")}:${String(c%60).padStart(2,"0")}`,a=document.createElement("button");a.type="button",a.classList.add("boton-horario"),a.textContent=e,a.dataset.hora=e,n.has(e)?(a.disabled=!0,a.classList.add("ocupado")):a.addEventListener("click",()=>{document.querySelectorAll(".boton-horario").forEach(e=>e.classList.remove("seleccionado")),a.classList.add("seleccionado"),inputHora.value=e}),s.appendChild(a),c+=t}}async function generarBotonesBloqueosYReservas(e,a){if(contenedor.innerHTML="",!e)return;const o=new Date(e);o.setHours(0,0,0,0);const r=new Date;if(r.setHours(0,0,0,0),0===o.getDay()||o<r)return void mostrarMensaje("No se pueden bloquear horarios en domingo o fechas pasadas");if(!a||"todos"===a)return void mostrarMensaje("Selecciona un barbero para ver los horarios");const t=new Set;try{const o=new URL("/api/citas",window.location.origin);o.searchParams.set("fecha",e),o.searchParams.set("barberoID",a);const r=await fetch(o);if(r.ok){(await r.json()).forEach(e=>{e.hora&&t.add(e.hora.substring(0,5))})}const n=new URL("/bloqueos/obtener",window.location.origin);n.searchParams.set("fecha",e),n.searchParams.set("barberoID",a);const s=await fetch(n);if(s.ok){(await s.json()).forEach(e=>{if(e.hora)t.add(e.hora.substring(0,5));else{let e;e=520;const a=800;for(;e<=a;){const a=String(Math.floor(e/60)).padStart(2,"0"),o=String(e%60).padStart(2,"0");t.add(`${a}:${o}`),e+=40}e=920;const o=1160;for(;e<=o;){const a=String(Math.floor(e/60)).padStart(2,"0"),o=String(e%60).padStart(2,"0");t.add(`${a}:${o}`),e+=40}}})}generarRangoHorarios(8,40,13,20,40,t,contenedor),generarRangoHorarios(15,20,19,20,40,t,contenedor)}catch(e){console.error("Error al cargar citas o bloqueos:",e),mostrarMensaje("No se pudieron cargar los horarios")}}document.addEventListener("DOMContentLoaded",iniciarApp),inputFecha.addEventListener("change",()=>{"todos"!==selectBarbero.value&&generarBotonesBloqueosYReservas(inputFecha.value,selectBarbero.value)}),selectBarbero.addEventListener("change",()=>{"todos"===selectBarbero.value?inputHora.value?mostrarMensaje("Se aplicar√° la hora seleccionada a todos los barberos"):mostrarMensaje("Selecciona un barbero primero para ver los horarios"):generarBotonesBloqueosYReservas(inputFecha.value,selectBarbero.value)}),inputFecha.value&&"todos"!==selectBarbero.value&&generarBotonesBloqueosYReservas(inputFecha.value,selectBarbero.value);