const TOTAL_PASOS=3;let diaSeleccionadoEl=null,paso=1;const pasoInicial=1;let calendar,calendarioYaInicializado=!1;const cita={id:"",nombre:"",fecha:"",hora:"",servicios:[],barberoId:""};function ymdLocal(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function parseFechaLocal(e){if(/^\d{4}-\d{2}-\d{2}$/.test(e)){const[t,a,o]=e.split("-").map(Number);return new Date(t,a-1,o)}return new Date(e)}function iniciarApp(){mostrarSeccion(paso),tabs(),botonesPaginador(paso),actualizarTabActual(paso),paginaSiguiente(),paginaAnterior(),consultarAPI(),consultarBarberos(),idCliente(),nombreCliente(),mostrarResumen()}async function inicializarCalendario(){const e=document.getElementById("calendario");if(calendarioYaInicializado)return;calendar=new FullCalendar.Calendar(e,{initialView:"dayGridMonth",initialDate:new Date,locale:"es",firstDay:1,selectable:!0,editable:!1,timeZone:"local",headerToolbar:{left:"title",center:"",right:"prev,next"},dayCellDidMount:function(e){const t=new Date(e.date.getFullYear(),e.date.getMonth(),e.date.getDate()),a=new Date;a.setHours(0,0,0,0),0===t.getDay()||t<a?e.el.classList.add("dia-deshabilitado"):e.el.classList.add("habilitado")},dateClick:async function(e){const t=parseFechaLocal(ymdLocal(e.date));t.setHours(0,0,0,0);const a=new Date;if(a.setHours(0,0,0,0),0===t.getDay()||t<a)return;limpiarHorarios(),document.querySelector("#hora").value="",cita.hora="";const o=ymdLocal(t);document.querySelector("#fecha").value=o,cita.fecha=o,await cargarEventosYBloqueos(),diaSeleccionadoEl&&diaSeleccionadoEl.classList.remove("fecha-seleccionada"),diaSeleccionadoEl=e.dayEl,diaSeleccionadoEl.classList.add("fecha-seleccionada")}}),calendar.render(),calendarioYaInicializado=!0;const t=new Date;if(t.setHours(0,0,0,0),0!==t.getDay()){const a=ymdLocal(t);document.querySelector("#fecha").value=a,cita.fecha=a,await cargarEventosYBloqueos();const o=e.querySelector(`[data-date="${a}"]`);o&&(o.classList.add("fecha-seleccionada"),diaSeleccionadoEl=o)}}function generarRangoHorarios(e,t,a,o,n,r,c,i){let s=60*e+t;const l=60*a+o,d=new Date,u=d.toISOString().split("T")[0];for(;s<=l;){const e=Math.floor(s/60).toString().padStart(2,"0"),t=(s%60).toString().padStart(2,"0"),a=`${e}:${t}`,o=document.createElement("button");o.type="button",o.classList.add("boton-horario"),o.textContent=a,o.dataset.hora=a;let l=!1;if(i===u){60*parseInt(e)+parseInt(t)<=60*d.getHours()+d.getMinutes()&&(l=!0)}r.has(a)||l?(o.disabled=!0,o.classList.add("ocupado")):o.addEventListener("click",function(){document.querySelectorAll(".boton-horario").forEach(e=>e.classList.remove("seleccionado")),o.classList.add("seleccionado"),document.querySelector("#hora").value=a,cita.hora=a}),c.appendChild(o),s+=n}}function generarBotonesHorarios(e=[],t){const a=document.getElementById("horarios-container");a.innerHTML="",a.classList.add("visible");const o=new Set;e.forEach(e=>{if(e.fecha===t)if(e.hora)o.add(e.hora.substring(0,5));else for(let e=8;e<=19;e++)e>=8&&e<=13&&[20,0,40].forEach(t=>{o.add(`${String(e).padStart(2,"0")}:${String(t).padStart(2,"0")}`)}),e>=15&&e<=19&&[20,0,40].forEach(t=>{o.add(`${String(e).padStart(2,"0")}:${String(t).padStart(2,"0")}`)})});generarRangoHorarios(8,40,13,20,40,o,a,t),generarRangoHorarios(15,20,19,20,40,o,a,t)}function mostrarSeccion(e){const t=document.querySelector(".mostrar");t&&t.classList.remove("mostrar");const a=`#paso-${e}`;document.querySelector(a).classList.add("mostrar"),2===e&&inicializarCalendario()}function limpiarHorarios(){document.getElementById("horarios-container").innerHTML=""}function actualizarTabActual(e){const t=document.querySelector(".tabs .actual");t&&t.classList.remove("actual");const a=document.querySelector(`[data-paso="${e}"]`);a&&a.classList.add("actual")}function tabs(){document.querySelectorAll(".tabs button").forEach(e=>{e.addEventListener("click",function(e){const t=parseInt(e.target.dataset.paso);mostrarSeccion(t),botonesPaginador(t),actualizarTabActual(t)})})}function botonesPaginador(e){const t=document.querySelector("#anterior"),a=document.querySelector("#siguiente");t.classList.remove("ocultar"),a.classList.remove("ocultar"),t.classList.toggle("ocultar",1===e),a.classList.toggle("ocultar",3===e),3===e&&mostrarResumen()}function paginaAnterior(){document.querySelector("#anterior").addEventListener("click",function(){paso<=1||(paso--,mostrarSeccion(paso),botonesPaginador(paso),actualizarTabActual(paso),window.scrollTo({top:0,behavior:"smooth"}))})}function paginaSiguiente(){document.querySelector("#siguiente").addEventListener("click",function(){if(1!==paso||0!==cita.servicios.length){if(2===paso){if(Object.values(cita).includes("")||0===cita.servicios.length)return void mostrarAlerta("Completa todos los campos","error",".formulario",!0)}paso>=3||(paso++,mostrarSeccion(paso),botonesPaginador(paso),actualizarTabActual(paso),window.scrollTo({top:0,behavior:"smooth"}))}else mostrarAlerta("Selecciona al menos un servicio","error",".listado-servicios",!0)})}async function consultarAPI(){try{const e="/api/servicios",t=await fetch(e);mostrarServicios(await t.json())}catch(e){console.log(e)}}function mostrarServicios(e){e.forEach(e=>{const{id:t,nombre:a,precio:o}=e,n=document.createElement("P");n.classList.add("nombre-servicio"),n.textContent=a;const r=document.createElement("P");r.classList.add("precio-servicio"),r.textContent=`$${o}`;const c=document.createElement("DIV");c.classList.add("servicio"),c.dataset.idServicio=t,c.onclick=function(){selecionarServicio(e)},c.appendChild(n),c.appendChild(r),document.querySelector("#servicios").appendChild(c)})}function selecionarServicio(e){const{id:t}=e,{servicios:a}=cita,o=document.querySelector(`[data-id-servicio="${t}"]`);a.some(e=>e.id===t)?(cita.servicios=a.filter(e=>e.id!==t),o.classList.remove("seleccionado")):(cita.servicios=[...a,e],o.classList.add("seleccionado"))}function idCliente(){cita.id=document.querySelector("#id").value}function nombreCliente(){cita.nombre=document.querySelector("#nombre").value}function mostrarAlerta(e,t,a,o=!0){const n=document.querySelector(".alerta");n&&n.remove();const r=document.createElement("DIV");r.textContent=e,r.classList.add("alerta"),r.classList.add(t);document.querySelector(a).appendChild(r),o&&setTimeout(()=>{r.remove()},3e3)}function mostrarResumen(){const e=document.querySelector(".contenido-resumen");for(;e.firstChild;)e.removeChild(e.firstChild);const{nombre:t,fecha:a,hora:o,servicios:n}=cita,r=document.createElement("H3");r.textContent="Resumen de Servicios",e.appendChild(r),n.forEach(t=>{const{id:a,precio:o,nombre:n}=t,r=document.createElement("DIV");r.classList.add("contenedor-servicio");const c=document.createElement("P");c.innerHTML=`Servicio: <span>${n}</span>`;const i=document.createElement("P");i.innerHTML=`Precio: <span>$${o}</span>`,r.appendChild(c),r.appendChild(i),e.appendChild(r)});const c=document.createElement("H3");c.textContent="Resumen de Cita",e.appendChild(c);const i=document.createElement("P");i.innerHTML=`Nombre: <span>${t}</span>`;const s=parseFechaLocal(a).toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),l=document.createElement("P");l.innerHTML=`Fecha: <span>${s}</span>`;const d=document.createElement("P");d.innerHTML=`Hora: <span>${o} Horas</span>`;const u=document.createElement("P");u.innerHTML=`Barbero: <span>${cita.barberoNombre}</span>`;const m=document.createElement("BUTTON");m.id="btnReservar",m.classList.add("boton"),m.textContent="Reservar Cita",m.onclick=reservarCita,e.appendChild(i),e.appendChild(l),e.appendChild(d),e.appendChild(u),e.appendChild(m)}async function reservarCita(){const e=document.querySelector("#btnReservar");if(e.disabled=!0,e.textContent="Procesando...",!cita.barberoId)return mostrarAlerta("Selecciona un barbero antes de reservar","error",".contenido-resumen"),e.disabled=!1,void(e.textContent="Reservar");const{nombre:t,fecha:a,hora:o,servicios:n,id:r}=cita,c=n.map(e=>e.id),i=new FormData,s=document.querySelector("#csrf_token").value;i.append("csrf_token",s),i.append("fecha",a),i.append("hora",o),i.append("usuarioID",r),i.append("servicios",c),i.append("barberoID",cita.barberoId);try{const e="/api/citas",t=await fetch(e,{method:"POST",body:i}),n=await t.json();if(!n.resultado||!n.resultado.resultado)throw new Error("Error en la respuesta del servidor");Swal.fire({title:"<strong>Cita creada correctamente</strong>",html:`\n                    <p><span>Barbero:</span> <b>${cita.barberoNombre}</b></p>\n                    <p><span>Fecha:</span> <b>${a}</b></p>\n                    <p><span>Hora:</span> <b>${o}</b></p>\n                `,icon:"success",showConfirmButton:!0,confirmButtonText:"Aceptar",background:"#f0f8ff",iconColor:"#28a745",customClass:{title:"swal-title",htmlContainer:"swal-text"}}).then(()=>{window.location.href="/citas"})}catch(t){Swal.fire({icon:"error",title:"⚠ Error",text:"Hubo un error al guardar la cita",confirmButtonText:"Intentar de nuevo",background:"#fff3f3",iconColor:"#dc3545"}),e.disabled=!1,e.textContent="Reservar"}}async function consultarBarberos(){try{const e="/api/barberos",t=await fetch(e);llenarSelectBarberos(await t.json())}catch(e){console.error("Error cargando barberos:",e)}}async function seleccionarBarberoAutomatico(e,t){const a=await fetch(`/api/citas/fecha?fecha=${e.fecha}`),o=await a.json();let n=t.filter(t=>!o.some(a=>a.barberoID==t.id&&a.hora===e.hora));if(n.length>0){const t=n[Math.floor(Math.random()*n.length)];e.barberoId=t.id,e.barberoNombre=t.nombre}else console.warn("Ningún barbero disponible a esa hora");return e}async function llenarSelectBarberos(e){const t=document.querySelector("#barbero");t.innerHTML="";const a=document.createElement("option");a.value="",a.textContent="-- Selecciona un barbero --",t.appendChild(a),e.forEach(e=>{const a=document.createElement("option");a.value=e.id,a.textContent=e.nombre+" "+e.apellido,a.dataset.image=e.imagen?"/uploads/"+e.imagen:"",t.appendChild(a)}),await seleccionarBarberoAutomatico(cita,e),cita.barberoId&&(t.value=cita.barberoId),transformarSelectEnCustom("barbero"),t.addEventListener("change",async function(){const e=this.options[this.selectedIndex];cita.barberoId=e.value,cita.barberoNombre=e.textContent,limpiarHorarios(),cita.hora="",document.querySelector("#hora").value="",await cargarEventosYBloqueos()})}async function cargarEventosYBloqueos(){const e=cita.fecha,t=cita.barberoId;if(e&&t)try{const[a,o]=await Promise.all([fetch(`/api/citas?fecha=${e}&barberoID=${t}`),fetch(`/bloqueos/obtener?fecha=${e}&barberoID=${t}`)]),n=a.ok?await a.json():[],r=o.ok?await o.json():[];generarBotonesHorarios([...n,...r],e)}catch(e){console.error("Error al cargar eventos y bloqueos:",e),limpiarHorarios()}else limpiarHorarios()}function transformarSelectEnCustom(e){const t=document.getElementById(e),a=document.createElement("div");a.classList.add("custom-select"),a.style.display="block";const o=document.createElement("div");o.classList.add("selected"),a.appendChild(o);const n=document.createElement("div");function r(e){if(o.innerHTML="",e.dataset.image){const t=document.createElement("img");t.src=e.dataset.image,t.classList.add("img-option"),o.appendChild(t),o.appendChild(document.createTextNode(" "+e.textContent))}else o.textContent=e.textContent}n.classList.add("options"),Array.from(t.options).forEach(e=>{const a=document.createElement("div");if(a.classList.add("option"),a.textContent=e.textContent,a.dataset.value=e.value,e.dataset.image){const t=document.createElement("img");t.src=e.dataset.image,t.classList.add("img-option"),a.prepend(t)}""===e.value&&a.classList.add("disabled"),t.selectedIndex===Array.from(t.options).indexOf(e)&&r(e),a.addEventListener("click",function(){a.classList.contains("disabled")||(t.value=this.dataset.value,r(e),n.style.display="none",t.dispatchEvent(new Event("change")))}),n.appendChild(a)}),a.appendChild(n),o.addEventListener("click",function(){n.style.display="block"===n.style.display?"none":"block"}),document.addEventListener("click",function(e){a.contains(e.target)||(n.style.display="none")}),t.style.position="absolute",t.style.left="-9999px",t.style.visibility="hidden",t.style.display="none",t.parentNode.insertBefore(a,t.nextSibling)}document.addEventListener("DOMContentLoaded",function(){iniciarApp()});