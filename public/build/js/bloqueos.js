let calendar,calendarioYaInicializado=!1,diaSeleccionadoEl=null,cita={fecha:"",hora:""};async function inicializarCalendario(){const e=document.getElementById("calendario"),a=document.getElementById("fecha"),t=document.querySelector('input[name="hora"]'),o=document.querySelector('select[name="barberoID"]');if(!e||calendarioYaInicializado)return;const n=new Date;n.setHours(0,0,0,0),calendar=new FullCalendar.Calendar(e,{initialView:"dayGridMonth",locale:"es",firstDay:1,selectable:!0,editable:!1,timeZone:"local",headerToolbar:{left:"title",center:"",right:"prev,next"},dayCellDidMount:function(e){const a=new Date(e.date);a.setHours(0,0,0,0),0===a.getDay()||a<n?e.el.classList.add("dia-deshabilitado"):e.el.classList.add("habilitado")},dateClick:async function(e){if(e.dayEl.classList.contains("dia-deshabilitado"))return;diaSeleccionadoEl&&diaSeleccionadoEl.classList.remove("fecha-seleccionada"),diaSeleccionadoEl=e.dayEl,diaSeleccionadoEl.classList.add("fecha-seleccionada");const n=ymdLocal(e.date);a.value=n,cita.fecha=n,t.value="",cita.hora="",o.value&&"todos"!==o.value?await generarBotonesBloqueosYReservas(n,o.value):mostrarMensaje("Selecciona un barbero para ver los horarios")},datesSet:function(){if(!diaSeleccionadoEl&&0!==n.getDay()){const t=ymdLocal(n),r=e.querySelector(`[data-date="${t}"]`);r&&(r.classList.add("fecha-seleccionada"),diaSeleccionadoEl=r,a.value=t,cita.fecha=t,o.value&&"todos"!==o.value&&generarBotonesBloqueosYReservas(t,o.value))}}}),calendar.render(),calendarioYaInicializado=!0}function ymdLocal(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function transformarSelectEnCustom(e){const a=document.getElementById(e);if(!a)return;const t=document.createElement("div");t.classList.add("custom-select"),t.style.display="block";const o=document.createElement("div");o.classList.add("selected"),t.appendChild(o);const n=document.createElement("div");function r(e){if(o.innerHTML="",e.dataset.image){const a=document.createElement("img");a.src=e.dataset.image,a.classList.add("img-option"),o.appendChild(a),o.appendChild(document.createTextNode(" "+e.textContent))}else o.textContent=e.textContent}n.classList.add("options"),Array.from(a.options).forEach(e=>{const t=document.createElement("div");if(t.classList.add("option"),t.textContent=e.textContent,t.dataset.value=e.value,e.dataset.image){const a=document.createElement("img");a.src=e.dataset.image,a.classList.add("img-option"),t.prepend(a)}""===e.value&&t.classList.add("disabled"),a.selectedIndex===Array.from(a.options).indexOf(e)&&r(e),t.addEventListener("click",function(){t.classList.contains("disabled")||(a.value=this.dataset.value,r(e),n.style.display="none",a.dispatchEvent(new Event("change")))}),n.appendChild(t)}),t.appendChild(n),o.addEventListener("click",function(){n.style.display="block"===n.style.display?"none":"block"}),document.addEventListener("click",function(e){t.contains(e.target)||(n.style.display="none")}),a.style.position="absolute",a.style.left="-9999px",a.style.visibility="hidden",a.style.display="none",a.parentNode.insertBefore(t,a.nextSibling)}function generarRangoHorarios(e,a,t,o,n,r,s){let c=60*e+a;const i=60*t+o;for(;c<=i;){const e=`${String(Math.floor(c/60)).padStart(2,"0")}:${String(c%60).padStart(2,"0")}`,a=document.createElement("button");a.type="button",a.classList.add("boton-horario"),a.textContent=e,a.dataset.hora=e,r.has(e)?(a.disabled=!0,a.classList.add("ocupado")):a.addEventListener("click",()=>{document.querySelectorAll(".boton-horario").forEach(e=>e.classList.remove("seleccionado")),a.classList.add("seleccionado"),document.querySelector('input[name="hora"]').value=e}),s.appendChild(a),c+=n}}async function generarBotonesBloqueosYReservas(e,a){const t=document.getElementById("horarios-wrapper");if(!t)return console.error("No existe el wrapper #horarios-wrapper en el HTML");if(t.innerHTML="",!e)return;const o=new Date(e);o.setHours(0,0,0,0);const n=new Date;if(n.setHours(0,0,0,0),0===o.getDay()||o<n)return void(t.innerHTML='<p class="mensaje-no-horarios">No se pueden bloquear horarios en domingo o fechas pasadas</p>');if(!a||"todos"===a)return void(t.innerHTML='<p class="mensaje-no-horarios">Selecciona un barbero para ver los horarios</p>');const r=new Set;try{const o=new URL("/api/citas",window.location.origin);o.searchParams.set("fecha",e),o.searchParams.set("barberoID",a);const n=await fetch(o);if(n.ok){(await n.json()).forEach(e=>{e.hora&&r.add(e.hora.substring(0,5))})}const s=new URL("/bloqueos/obtener",window.location.origin);s.searchParams.set("fecha",e),s.searchParams.set("barberoID",a);const c=await fetch(s);if(c.ok){(await c.json()).forEach(e=>{if(e.hora)r.add(e.hora.substring(0,5));else{let e;e=520;const a=800;for(;e<=a;){const a=String(Math.floor(e/60)).padStart(2,"0"),t=String(e%60).padStart(2,"0");r.add(`${a}:${t}`),e+=40}e=920;const t=1160;for(;e<=t;){const a=String(Math.floor(e/60)).padStart(2,"0"),t=String(e%60).padStart(2,"0");r.add(`${a}:${t}`),e+=40}}})}const i=document.createElement("p");i.classList.add("descripcion-pagina"),i.textContent="Hora (dejar vacío para todo el día):",t.appendChild(i);const d=document.createElement("div");d.id="horarios-container",d.classList.add("horarios-grid"),d.classList.add("visible"),t.appendChild(d),generarRangoHorarios(8,40,13,20,40,r,d),generarRangoHorarios(15,20,19,20,40,r,d)}catch(e){console.error("Error al cargar citas o bloqueos:",e),t.innerHTML='<p class="mensaje-no-horarios">No se pudieron cargar los horarios</p>'}}function mostrarMensaje(e){const a=document.getElementById("horarios-wrapper");a&&(a.innerHTML=`<p class="mensaje-no-horarios">${e}</p>`)}function confirmar(e,a,t=!1,o=null){const n=document.querySelector(".alerta-global");n&&n.remove(),document.body.style.overflow="hidden";const r=document.createElement("div");r.classList.add("alerta-overlay");const s=document.createElement("div");s.classList.add("alerta-global",a);const c=document.createElement("p");if(c.textContent=e,s.appendChild(c),t&&o){const e=document.createElement("div");e.classList.add("acciones");const a=document.createElement("button");a.textContent="Confirmar",a.classList.add("boton","boton-confirmar"),a.addEventListener("click",()=>{s.remove(),r.remove(),document.body.style.overflow="",o.submit()});const t=document.createElement("button");t.textContent="Cancelar",t.classList.add("boton","boton-cancelar"),t.addEventListener("click",()=>{s.remove(),r.remove(),document.body.style.overflow=""}),e.appendChild(a),e.appendChild(t),s.appendChild(e)}r.appendChild(s),document.body.appendChild(r)}document.addEventListener("DOMContentLoaded",()=>{inicializarCalendario();const e=document.querySelector('select[name="barberoID"]'),a=document.querySelector("#fecha"),t=document.getElementById("horarios-wrapper");transformarSelectEnCustom("barberoID"),"todos"===e.value?t.innerHTML='<p class="mensaje-no-horarios">Selecciona un barbero para ver los horarios</p>':generarBotonesBloqueosYReservas(a.value,e.value),e.addEventListener("change",()=>{const a=document.querySelector('input[name="hora"]'),t=document.getElementById("fecha");"todos"===e.value?a.value?mostrarMensaje("Se aplicará la hora seleccionada a todos los barberos"):mostrarMensaje("Selecciona un barbero primero para ver los horarios"):(a.value="",t.value&&generarBotonesBloqueosYReservas(t.value,e.value))})}),document.getElementById("crear-bloqueo").addEventListener("click",()=>{const e=document.querySelector("form"),a=document.getElementById("fecha"),t=document.querySelector('select[name="barberoID"]');a.value?"todos"!==t.value?confirmar("¿Deseas crear el bloqueo para este barbero y fecha?","warning",!0,e):confirmar("Se aplicará el bloqueo a todos los barberos, ¿deseas continuar?","warning",!0,e):mostrarMensaje("Selecciona una fecha primero")});