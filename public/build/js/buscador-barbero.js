let diaSeleccionadoEl=null,bloqueosMes=[];function iniciarApp(){buscarPorFecha(),inicializarCalendario()}function buscarPorFecha(){const e=document.querySelector("#fecha");e&&e.addEventListener("input",function(e){const a=e.target.value;window.location=`?fecha=${a}`})}async function inicializarCalendario(){const e=document.getElementById("calendario");if(!e)return;const a=new Date;a.setHours(0,0,0,0);new FullCalendar.Calendar(e,{initialView:"dayGridMonth",locale:"es",firstDay:1,selectable:!0,editable:!1,timeZone:"local",headerToolbar:{left:"",center:"title",right:"prev,next"},dateClick:async function(e){e.dayEl.classList.contains("dia-deshabilitado")||await mostrarCitas(ymdLocal(e.date),e.dayEl)},dayCellDidMount:async function(e){const n=e.date,o=n.getDay();ymdLocal(n);(0===o||n<a)&&e.el.classList.add("dia-deshabilitado")}}).render();const n=document.querySelector("#fecha"),o=n?.value||ymdLocal(new Date),t=e.querySelector(`[data-date="${o}"]`);t&&!t.classList.contains("dia-deshabilitado")&&(t.classList.add("fecha-seleccionada"),diaSeleccionadoEl=t,mostrarCitas(o,t))}async function cargarBloqueos(e,a=null){const n=new URL("/bloqueos/obtener",window.location.origin);n.searchParams.set("fecha",e),a&&n.searchParams.set("barberoID",a);const o=await fetch(n);if(!o.ok)return console.error("Error en la petición",o.status),void(bloqueosMes=[]);const t=await o.text();console.log("Respuesta cruda de bloqueos:",t);try{bloqueosMes=JSON.parse(t),console.log("Bloqueos recibidos:",bloqueosMes)}catch(e){console.error("No se pudo parsear JSON de bloqueos:",e),bloqueosMes=[]}}async function mostrarCitas(e,a){try{diaSeleccionadoEl&&diaSeleccionadoEl.classList.remove("fecha-seleccionada"),a&&(diaSeleccionadoEl=a,diaSeleccionadoEl.classList.add("fecha-seleccionada"));const n=document.querySelector("#fecha");n&&(n.value=e);const o=document.getElementById("citas-barbero");if(o.innerHTML="",bloqueosMes.some(a=>a.fecha===e))return void(o.innerHTML="<h2>Este día está bloqueado, no hay citas</h2>");const t=await fetch(`/api/barbero/citas?fecha=${e}`);if(!t.ok){const e=await t.text();return void console.error("Error al obtener citas:",t.status,e)}const s=await t.json();if(0===s.length)return void(o.innerHTML="<h2>No hay citas en esta fecha</h2>");const i=document.createElement("ul");i.classList.add("citas");let c=null,l=0;s.forEach((e,a)=>{if(e.id!==c){if(null!==c){i.lastElementChild.innerHTML+=`\n                        <p class="total">Total: <span>$ ${l}</span></p>\n                    `}const a=document.createElement("li");a.innerHTML=`\n                    <p>ID: <span>${e.id}</span></p>\n                    <p>Hora: <span>${e.hora.substring(0,5)}</span></p>\n                    <p>Cliente: <span>${e.cliente||"---"}</span></p>\n                    <p>Email: <span>${e.email||"---"}</span></p>\n                    <p>Teléfono: <span>${e.telefono||"---"}</span></p>\n                    <p>Barbero: <span>${e.barbero||e.barberoID}</span></p>\n                    <h3>Servicios</h3>\n                `,i.appendChild(a),c=e.id,l=0}const n=i.lastElementChild;n.innerHTML+=`<p class="servicio">${e.servicio} - $${e.precio}</p>`,l+=Number(e.precio),a===s.length-1&&(n.innerHTML+=`\n                    <p class="total">Total: <span>$ ${l}</span></p>\n                `)}),o.appendChild(i)}catch(e){console.error(e)}}function ymdLocal(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}document.addEventListener("DOMContentLoaded",function(){iniciarApp()});