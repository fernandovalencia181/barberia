let diaSeleccionadoEl=null,cita={};document.addEventListener("DOMContentLoaded",()=>{iniciarApp()});const contenedor=document.getElementById("citas-admin");function iniciarApp(){buscarPorFecha(),inicializarCalendarioAdmin()}function buscarPorFecha(){const e=document.querySelector("#fecha");e&&e.addEventListener("input",function(e){const a=e.target.value;window.location=`?fecha=${a}`})}function inicializarCalendarioAdmin(){const e=document.getElementById("calendario");if(!e)return;const a=new FullCalendar.Calendar(e,{initialView:"dayGridMonth",locale:"es",firstDay:1,selectable:!0,editable:!1,timeZone:"local",headerToolbar:{left:"title",center:"",right:"prev,next"},dateClick:async function(e){diaSeleccionadoEl&&diaSeleccionadoEl.classList.remove("fecha-seleccionada"),diaSeleccionadoEl=e.dayEl,diaSeleccionadoEl.classList.add("fecha-seleccionada");const a=ymdLocal(e.date),t=document.querySelector("#fecha");t&&(t.value=a),await cargarCitasAdmin(a)}});a.render();const t=document.querySelector("#fecha"),n=t?.value||ymdLocal(new Date),o=e.querySelector(`[data-date="${n}"]`);o&&(o.classList.add("fecha-seleccionada"),diaSeleccionadoEl=o),cargarCitasAdmin(n)}function ymdLocal(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}async function cargarCitasAdmin(e){try{const a=document.querySelector('input[name="csrf_token"]').value,t=await fetch(`/api/admin/citas?fecha=${e}&csrf_token=${a}`);if(!t.ok)throw new Error("Error al obtener citas");const n=await t.json(),o=document.getElementById("citas-admin");if(o.innerHTML="",0===n.length)return void(o.innerHTML="<h3>No hay citas en esta fecha</h3>");const r=document.createElement("ul");r.classList.add("citas");let i=null,c=null,s=0;n.forEach((t,o)=>{t.id!==i&&(c&&(c.querySelector(".total span").textContent=`$ ${s}`),c=document.createElement("li"),c.dataset.citaId=t.id,c.innerHTML=`\n                    <p>ID: <span>${t.id}</span></p>\n                    <p>Hora: <span>${t.hora.substring(0,5)}</span></p>\n                    <p>Cliente: <span>${t.cliente||"---"}</span></p>\n                    <p>Email: <span>${t.email||"---"}</span></p>\n                    <p>Teléfono: <span>${t.telefono||"---"}</span></p>\n                    <p>Barbero: <span>${t.barbero}</span></p>\n                    <h3>Servicios</h3>\n                    <div class="servicios"></div>\n                    <p class="total">Total: <span>$ 0</span></p>\n                    <div class="acciones servicios">\n                        <form action="/api/eliminar" method="POST">\n                            <input type="hidden" name="id" value="${t.id}">\n                            <input type="hidden" name="csrf_token" value="${a}">\n                            <input type="submit" class="boton-eliminar" value="Eliminar">\n                        </form>\n                        <button class="btn-actualizar-hora boton" \n                            data-cita-id="${t.id}" \n                            data-barbero-id="${t.barberoID}" \n                            data-fecha="${e}">Cambiar Hora</button>\n                    </div>\n                    <div class="horarios-grid"></div>\n                `,r.appendChild(c),i=t.id,s=0);c.querySelector(".servicios").innerHTML+=`<p>${t.servicio}: <span>$${t.precio}</span></p>`,s+=Number(t.precio),o===n.length-1&&(c.querySelector(".total span").textContent=`$ ${s}`)}),o.appendChild(r),generarResumenBarberos(n,o)}catch(e){console.error(e)}}function generarResumenBarberos(e,a){const t={};let n=0,o=0;e.forEach(e=>{t[e.barbero]||(t[e.barbero]={cantidad:0,total:0}),t[e.barbero].cantidad+=1,t[e.barbero].total+=Number(e.precio),n+=Number(e.precio),o++});const r=document.createElement("div");r.classList.add("resumen-barberos"),r.innerHTML="<h3>Resumen</h3>";for(const[e,a]of Object.entries(t))r.innerHTML+=`\n            <p>${e}: <span>${a.cantidad} cortes</span> - Total: <span>$${a.total}</span></p>\n        `;r.innerHTML+=`\n        <hr>\n        <p><strong>Total cortes:</strong> <span>${o}</span></p>\n        <p><strong>Total general:</strong> <span>$${n}</span></p>\n    `,a.appendChild(r)}async function mostrarHorariosDisponibles(e,a,t,n){try{const o=await fetch(`/api/citas?fecha=${e}&barberoID=${a}`);if(!o.ok)throw new Error("Error al obtener citas");const r=await o.json(),i=new Set(r.map(e=>e.hora?.substring(0,5)));n.innerHTML="";const c=40;generarRangoHorarios(8,40,13,20,c,i,n),generarRangoHorarios(15,20,19,20,c,i,n);const s=document.createElement("button");s.type="button",s.textContent="Guardar",s.classList.add("boton","boton-guardar"),s.addEventListener("click",async()=>{const e=n.dataset.horaSeleccionada;if(!e)return alert("Seleccione un horario primero");await actualizarHoraCita(t,e)}),n.appendChild(s)}catch(e){console.error(e)}}function generarRangoHorarios(e,a,t,n,o,r,i){let c=60*e+a;const s=60*t+n;for(;c<=s;){const e=`${Math.floor(c/60).toString().padStart(2,"0")}:${(c%60).toString().padStart(2,"0")}`,a=document.createElement("button");a.type="button",a.classList.add("boton-horario"),a.textContent=e,a.dataset.hora=e,r.has(e)?(a.disabled=!0,a.classList.add("ocupado")):a.addEventListener("click",function(){document.querySelectorAll(".boton-horario").forEach(e=>e.classList.remove("seleccionado")),a.classList.add("seleccionado"),i.dataset.horaSeleccionada=e}),i.appendChild(a),c+=o}}async function actualizarHoraCita(e,a){try{const t=document.querySelector('input[name="csrf_token"]').value,n=(await fetch("/api/citas/actualizar-hora",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e,hora:a,csrf_token:t})}),document.querySelector("#fecha"));n&&await cargarCitasAdmin(n.value)}catch(e){console.error(e),alert("No se pudo actualizar la hora")}}function confirmar(e,a,t=!1,n=null){const o=document.querySelector(".alerta-global");o&&o.remove(),document.body.style.overflow="hidden";const r=document.createElement("div");r.classList.add("alerta-overlay");const i=document.createElement("div");i.classList.add("alerta-global",a);const c=document.createElement("p");if(c.textContent=e,i.appendChild(c),t&&n){const e=document.createElement("div");e.classList.add("acciones");const a=document.createElement("button");a.textContent="Confirmar",a.classList.add("boton","boton-confirmar"),a.addEventListener("click",()=>{i.remove(),r.remove(),document.body.style.overflow="",n.submit()});const t=document.createElement("button");t.textContent="Cancelar",t.classList.add("boton","boton-cancelar"),t.addEventListener("click",()=>{i.remove(),r.remove(),document.body.style.overflow=""}),e.appendChild(a),e.appendChild(t),i.appendChild(e)}r.appendChild(i),document.body.appendChild(r)}document.getElementById("scrollBtn").addEventListener("click",e=>{e.preventDefault(),document.querySelector(".resumen-barberos").scrollIntoView({behavior:"smooth",block:"start"})}),contenedor.addEventListener("click",async e=>{if(e.target.classList.contains("boton-eliminar")){e.preventDefault();confirmar("¿Seguro que deseas eliminar esta cita?","warning",!0,e.target.closest("form"))}if(e.target.classList.contains("btn-actualizar-hora")){const a=e.target,t=a.closest("li").querySelector(".horarios-grid");if(t.classList.contains("visible"))t.classList.remove("visible"),a.textContent="Cambiar Hora";else if(t.classList.add("visible"),a.textContent="Contraer",!t.hasChildNodes()){const e=a.dataset.citaId,n=a.dataset.barberoId,o=a.dataset.fecha;await mostrarHorariosDisponibles(o,n,e,t)}}});